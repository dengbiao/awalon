# Task 1.3.7: 实现特殊角色能力界面

## 任务描述

设计并实现阿瓦隆游戏中特殊角色的能力使用界面，包括梅林的预知能力、派西维尔的辨识能力、莫甘娜的欺骗能力、莫德雷德的隐匿能力以及奥伯伦的孤立能力等。该界面需要在保证游戏平衡性的前提下，为特殊角色提供直观、便捷的能力使用体验，增强游戏的策略深度和角色特性。

## 详细需求

### 功能需求

1. **梅林预知界面**

   - 在游戏开始时，向梅林角色展示所有邪恶阵营角色（除莫德雷德外）
   - 提供查看邪恶角色的方式，但不明确指出具体角色身份
   - 在游戏过程中允许梅林随时查看这些信息

2. **派西维尔辨识界面**

   - 在游戏开始时，向派西维尔角色展示梅林和莫甘娜（但不区分谁是谁）
   - 提供查看这两个角色的方式，但不明确指出谁是梅林谁是莫甘娜
   - 在游戏过程中允许派西维尔随时查看这些信息

3. **邪恶阵营互识界面**

   - 在游戏开始时，向所有邪恶阵营角色（除奥伯伦外）展示其他邪恶阵营角色
   - 明确标识每个邪恶角色的具体身份
   - 在游戏过程中允许邪恶角色随时查看这些信息

4. **特殊能力使用界面**

   - 为刺客提供游戏结束时刺杀梅林的操作界面
   - 为其他可能的特殊角色（如湖中仙女）提供相应的能力使用界面
   - 能力使用有明确的视觉和音效反馈

5. **角色信息查看**

   - 允许所有玩家随时查看自己的角色信息
   - 提供角色能力的详细说明和使用提示
   - 显示与自己角色相关的其他玩家信息（如适用）

6. **能力使用记录**
   - 记录特殊能力的使用情况（如适用）
   - 在游戏结束时展示关键能力使用的结果
   - 提供能力使用历史的查看功能（如适用）

### 界面要求

1. **角色能力展示设计**

   - 设计符合中世纪风格的角色能力展示界面
   - 使用直观的视觉元素表示不同角色和阵营
   - 确保信息展示清晰，易于理解

2. **能力使用交互设计**

   - 设计简洁明了的能力使用操作流程
   - 提供确认机制，防止误操作
   - 能力使用结果有明确的视觉反馈

3. **信息保密设计**

   - 确保特殊角色信息只对应角色可见
   - 设计防窥屏机制，如快速隐藏按钮
   - 提供信息查看的安全提示

4. **视觉效果设计**

   - 为不同角色能力设计独特的视觉效果
   - 使用动画强化能力使用的体验
   - 确保视觉效果符合游戏整体风格

5. **响应式设计**
   - 适配不同屏幕尺寸的设备
   - 在小屏幕设备上优化操作体验
   - 支持横屏和竖屏模式

### 技术要求

1. **安全机制**

   - 实现角色信息的安全传输和展示
   - 防止通过客户端调试等方式获取其他玩家信息
   - 服务端验证能力使用的合法性

2. **实时更新**

   - 确保能力使用结果实时同步到相关玩家
   - 处理网络延迟情况下的状态同步
   - 提供能力使用失败时的重试机制

3. **性能优化**

   - 优化特殊效果的渲染性能
   - 确保动画效果不影响游戏流畅度
   - 适配低端设备的性能表现

4. **异常处理**
   - 处理网络异常情况下的能力使用恢复
   - 提供能力使用失败的错误提示
   - 确保游戏状态的一致性

## 实现步骤

1. **设计角色能力界面**

   - 设计各特殊角色的能力展示界面
   - 规划能力使用的交互流程
   - 设计能力使用的视觉效果

2. **开发基础角色信息展示**

   - 实现角色信息的安全获取和展示
   - 开发角色信息查看的交互功能
   - 实现信息保密的安全机制

3. **开发梅林和派西维尔能力界面**

   - 实现梅林查看邪恶角色的功能
   - 开发派西维尔辨识梅林和莫甘娜的功能
   - 设计相应的视觉效果和交互体验

4. **开发邪恶阵营互识界面**

   - 实现邪恶角色互相识别的功能
   - 开发角色身份的明确标识
   - 设计邪恶阵营的视觉风格

5. **开发刺客能力界面**

   - 实现游戏结束时刺客选择刺杀目标的功能
   - 开发刺杀结果的判定和展示
   - 设计刺杀过程的动画效果

6. **集成和优化**
   - 将各角色能力界面集成到游戏主流程
   - 优化能力使用的性能和体验
   - 测试不同角色组合下的功能正确性

## 数据结构

```typescript
// 角色类型枚举
enum CharacterType {
  MERLIN = "merlin", // 梅林
  PERCIVAL = "percival", // 派西维尔
  LOYAL_SERVANT = "loyal", // 忠臣
  ASSASSIN = "assassin", // 刺客
  MORGANA = "morgana", // 莫甘娜
  MORDRED = "mordred", // 莫德雷德
  OBERON = "oberon", // 奥伯伦
  MINION = "minion", // 爪牙
}

// 阵营枚举
enum Alignment {
  GOOD = "good", // 好人阵营
  EVIL = "evil", // 坏人阵营
}

// 角色能力枚举
enum CharacterAbility {
  SEE_EVIL = "seeEvil", // 梅林看到邪恶
  SEE_MERLIN_MORGANA = "seeMerlinMorgana", // 派西维尔看到梅林和莫甘娜
  KNOW_EVIL = "knowEvil", // 邪恶互相认识
  HIDDEN_FROM_MERLIN = "hiddenFromMerlin", // 莫德雷德对梅林隐藏
  ASSASSINATE = "assassinate", // 刺客刺杀
  ISOLATED = "isolated", // 奥伯伦的孤立
}

// 角色信息接口
interface CharacterInfo {
  characterId: string; // 角色ID
  characterType: CharacterType; // 角色类型
  alignment: Alignment; // 阵营
  abilities: CharacterAbility[]; // 拥有的能力
  visibleCharacters?: VisibleCharacter[]; // 可见的其他角色
  description: string; // 角色描述
  imageUrl: string; // 角色图片URL
}

// 可见角色接口
interface VisibleCharacter {
  playerId: string; // 玩家ID
  playerName: string; // 玩家名称
  possibleTypes?: CharacterType[]; // 可能的角色类型（如派西维尔看到的梅林/莫甘娜）
  certainType?: CharacterType; // 确定的角色类型（如邪恶互识）
  alignment: Alignment; // 阵营
}

// 能力使用请求接口
interface AbilityUseRequest {
  gameId: string; // 游戏ID
  playerId: string; // 玩家ID
  abilityType: CharacterAbility; // 能力类型
  targetId?: string; // 目标玩家ID（如适用）
  timestamp: number; // 请求时间戳
}

// 能力使用结果接口
interface AbilityUseResult {
  success: boolean; // 是否成功
  abilityType: CharacterAbility; // 能力类型
  resultData?: any; // 结果数据（根据能力类型不同而不同）
  message?: string; // 结果消息
  affectedPlayers?: string[]; // 受影响的玩家ID
}

// 刺杀结果接口
interface AssassinationResult {
  targetId: string; // 目标玩家ID
  targetName: string; // 目标玩家名称
  isMerlin: boolean; // 是否为梅林
  gameResult: "good" | "evil"; // 游戏最终结果
}
```

## 界面原型

```
+------------------------------------------+
|        特殊角色能力界面 - 梅林视角        |
+------------------------------------------+
|                                          |
|  你的角色: 梅林                          |
|  [角色图片]                              |
|                                          |
|  能力: 你知道谁是邪恶阵营(除莫德雷德外)   |
|                                          |
|  你看到的邪恶阵营成员:                   |
|                                          |
|  +------+  +------+  +------+           |
|  |玩家2  |  |玩家5  |  |玩家7  |           |
|  |邪恶   |  |邪恶   |  |邪恶   |           |
|  +------+  +------+  +------+           |
|                                          |
|  注意: 莫德雷德不会被你看到               |
|  保持谨慎，不要暴露你的身份！             |
|                                          |
|  [关闭]                [快速隐藏(ESC)]    |
+------------------------------------------+
```

```
+------------------------------------------+
|      特殊角色能力界面 - 派西维尔视角      |
+------------------------------------------+
|                                          |
|  你的角色: 派西维尔                      |
|  [角色图片]                              |
|                                          |
|  能力: 你能看到梅林和莫甘娜，但不知道谁是谁|
|                                          |
|  你看到的可能是梅林或莫甘娜的玩家:        |
|                                          |
|  +------+        +------+               |
|  |玩家1  |        |玩家4  |               |
|  |梅林?  |        |莫甘娜?|               |
|  |莫甘娜?|        |梅林?  |               |
|  +------+        +------+               |
|                                          |
|  提示: 仔细观察他们的行为，辨别真假梅林   |
|                                          |
|  [关闭]                [快速隐藏(ESC)]    |
+------------------------------------------+
```

```
+------------------------------------------+
|      特殊角色能力界面 - 邪恶阵营视角      |
+------------------------------------------+
|                                          |
|  你的角色: 莫甘娜                        |
|  [角色图片]                              |
|                                          |
|  能力: 你知道其他邪恶阵营成员             |
|        你对派西维尔显示为梅林             |
|                                          |
|  邪恶阵营成员:                           |
|                                          |
|  +------+  +------+  +------+           |
|  |你自己 |  |玩家5  |  |玩家7  |           |
|  |莫甘娜 |  |刺客   |  |莫德雷德|           |
|  +------+  +------+  +------+           |
|                                          |
|  注意: 奥伯伦不会出现在此列表中           |
|  协作阻止好人阵营完成任务！              |
|                                          |
|  [关闭]                [快速隐藏(ESC)]    |
+------------------------------------------+
```

```
+------------------------------------------+
|        特殊角色能力界面 - 刺客视角        |
+------------------------------------------+
|                                          |
|  执行刺杀                                |
|                                          |
|  选择你认为是梅林的玩家:                  |
|                                          |
|  +------+  +------+  +------+           |
|  |玩家1  |  |玩家3  |  |玩家6  |           |
|  |      |  |      |  |      |           |
|  +------+  +------+  +------+           |
|                                          |
|  +------+  +------+                     |
|  |玩家8  |  |玩家9  |                     |
|  |      |  |      |                     |
|  +------+  +------+                     |
|                                          |
|  提示: 选择正确将导致邪恶阵营胜利         |
|  请谨慎选择！                            |
|                                          |
|  [取消]                                  |
+------------------------------------------+
```

```
+------------------------------------------+
|           刺杀确认                       |
+------------------------------------------+
|                                          |
|  你确定要刺杀 玩家3 吗？                 |
|                                          |
|  此操作无法撤销，将决定游戏最终结果。     |
|                                          |
|  [取消]                [确认刺杀]         |
+------------------------------------------+
```

## 特殊角色能力界面（文本描述）

特殊角色能力界面是阿瓦隆游戏中展示和使用角色特殊能力的关键界面，设计遵循直观、安全和角色特性强化的原则：

1. **梅林预知界面**：

   - 界面顶部显示"梅林的预知"标题，使用神秘的蓝色光芒效果
   - 中央展示梅林角色图像和简短能力描述
   - 下方以圆形排列显示所有邪恶阵营成员（除莫德雷德外）
   - 邪恶成员显示为带红色光晕的剪影，不直接显示具体角色
   - 界面底部有重要提示："保持谨慎，不要暴露你的身份"
   - 右上角有快速隐藏按钮，按下 ESC 键也可快速隐藏
   - 查看时有微妙的心跳音效，增强紧张感

2. **派西维尔辨识界面**：

   - 界面顶部显示"派西维尔的洞察"标题，使用金色光芒效果
   - 中央展示派西维尔角色图像和简短能力描述
   - 下方并排显示两个角色（梅林和莫甘娜），但不标明谁是谁
   - 两个角色显示为带蓝紫色光晕的神秘形象
   - 界面底部有提示："这两人中，一位是梅林，一位是莫甘娜"
   - 同样有快速隐藏功能和安全提示
   - 查看时有神秘的低语音效，增强辨识的挑战性

3. **邪恶阵营互识界面**：

   - 界面顶部显示"黑暗同盟"标题，使用暗红色火焰效果
   - 中央简短说明："你们是邪恶阵营的同伴"
   - 下方清晰展示所有邪恶阵营成员，包括具体角色身份
   - 每个角色卡片有明确的角色名称和图像
   - 特殊标记奥伯伦（如果在游戏中）："他不认识你们，你们也不认识他"
   - 界面有阴暗的视觉风格，配合邪恶阵营的主题
   - 查看时有邪恶的低笑音效，强化阵营感

4. **刺客能力使用界面**：

   - 在游戏结束条件达成后，为刺客玩家显示"执行刺杀"界面
   - 界面以暗红色为主色调，中央有刺客角色图像
   - 显示所有可选择的刺杀目标（所有好人阵营玩家）
   - 每个目标以头像和名称展示，可点击选择
   - 选择后有确认对话框："你确定要刺杀[玩家名]吗？"
   - 刺杀执行后有戏剧性的动画效果：
     - 成功刺杀梅林：匕首刺入，画面变红，显示"邪恶胜利"
     - 刺杀错误：匕首折断，画面变蓝，显示"正义胜利"
   - 刺杀过程有紧张的音乐和音效

5. **角色信息查看界面**：

   - 可通过点击自己的头像或专门按钮随时查看
   - 界面显示完整的角色信息，包括：
     - 角色名称和图像
     - 阵营标识（好/邪恶）
     - 详细的角色能力描述
     - 游戏策略提示
     - 与自己相关的其他角色信息（如适用）
   - 设计符合角色特性的视觉风格
   - 提供快速隐藏功能，保护信息安全

6. **视觉设计**：

   - 好人阵营角色使用蓝色、金色等明亮色调
   - 邪恶阵营角色使用红色、黑色等暗色调
   - 角色图像采用中世纪风格的插画
   - 能力效果使用魔法般的粒子和光效
   - 界面元素有微妙的动画效果，如呼吸、脉动
   - 重要信息有强调效果，如光晕或轻微放大

7. **交互设计**：
   - 点击角色可查看更详细的信息
   - 长按可持续查看，松开立即隐藏（适用于需要保密的信息）
   - 能力使用有清晰的操作流程和反馈
   - 重要操作有确认步骤，防止误触
   - 提供快捷键支持，如 ESC 快速隐藏
   - 关键信息有引导性的视觉提示

通过这些设计元素，特殊角色能力界面不仅能够清晰展示游戏机制所需的信息，还能通过视觉和交互设计强化角色特性，增强游戏的沉浸感和策略深度，同时确保信息的安全性和使用的便捷性。

## 验收标准

1. **功能完整性**

   - 梅林能正确查看所有邪恶角色（除莫德雷德外）
   - 派西维尔能看到梅林和莫甘娜但无法区分
   - 邪恶角色能互相识别（除奥伯伦外）
   - 刺客能在游戏结束时执行刺杀操作
   - 所有玩家能随时查看自己的角色信息

2. **界面体验**

   - 角色能力界面设计美观，符合游戏风格
   - 信息展示清晰，易于理解
   - 能力使用操作简单直观
   - 视觉效果增强角色特性体验
   - 在不同尺寸的设备上显示正常

3. **安全性**

   - 特殊角色信息只对应角色可见
   - 快速隐藏功能有效保护信息安全
   - 客户端无法通过调试获取其他玩家信息
   - 能力使用有服务端验证

4. **技术性能**
   - 特殊效果不影响游戏流畅度
   - 能力使用响应迅速，无明显延迟
   - 在低端设备上保持良好性能
   - 断线重连后能恢复正确的角色信息

## 技术依赖

- PIXI.js 渲染引擎
- GSAP 动画库
- Socket.IO 客户端（实时通信）
- 游戏状态管理模块
- 加密通信模块（角色信息安全）

## 工作量估计

3 人天

## 相关文档

- [阿瓦隆游戏规则](../../../阿瓦隆游戏规则.md)
- [Story1.3 游戏进行界面 README](../README.md)
- [Story1.3 技术方案](../技术方案.md)
- [Task1.3.1 设计并实现角色信息展示界面](./Task1.3.1_设计并实现角色信息展示界面.md)
- [Task1.3.6 实现玩家交流功能](./Task1.3.6_实现玩家交流功能.md)
