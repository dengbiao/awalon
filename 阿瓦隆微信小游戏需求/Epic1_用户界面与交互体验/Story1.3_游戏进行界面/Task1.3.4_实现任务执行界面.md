# Task 1.3.4: 实现任务执行界面

## 任务描述

设计并实现阿瓦隆游戏中的任务执行界面，该界面用于被选中的任务队员秘密选择任务成功或失败。任务执行是游戏的核心环节，需要确保操作的保密性和公平性，同时为所有玩家提供清晰的任务结果反馈。

## 详细需求

### 功能需求

1. **任务信息展示**

   - 清晰显示当前任务轮次和重要性
   - 展示参与任务的队员名单
   - 标识当前任务所需的成功/失败条件（如 7-10 人游戏的第 4 轮任务需要 2 个失败票）
   - 显示历史任务的成功/失败情况

2. **任务卡选择（队员视角）**

   - 仅任务队员可以看到选择界面
   - 提供成功/失败两种任务卡选择
   - 好人阵营只能选择成功卡（系统强制）
   - 坏人阵营可以选择成功或失败卡
   - 确保选择过程的私密性

3. **等待界面（非队员视角）**

   - 非任务队员看到适当的等待界面
   - 显示当前任务执行进度（已提交/总队员数）
   - 提供适当的视觉反馈，增强游戏紧张感

4. **任务结果展示**

   - 所有队员完成选择后，向全体玩家展示任务结果
   - 显示成功/失败票数，但不显示具体是谁投的
   - 根据任务失败条件判定任务是否成功
   - 提供任务结果的视觉和音效反馈

5. **任务历史更新**
   - 更新任务状态板，记录当前任务的成功/失败
   - 显示当前任务成功/失败的总数统计
   - 根据任务结果，判断是否达成游戏结束条件

### 界面要求

1. **任务卡设计**

   - 设计醒目的成功/失败任务卡
   - 成功卡使用积极色调（如蓝色/金色）
   - 失败卡使用警示色调（如红色/黑色）
   - 卡片上有明确的文字和图标标识

2. **队员信息展示**

   - 清晰展示参与任务的队员
   - 标识当前用户是否为任务队员
   - 提供队员的基本信息（头像、名称）

3. **任务状态指示**

   - 为每位队员提供任务卡提交状态指示（未提交/已提交）
   - 使用动画或图标表示任务执行中的状态
   - 结果公布前不显示任何队员的具体选择

4. **结果展示设计**

   - 任务结果使用醒目的视觉效果展示
   - 成功/失败状态有明确的色彩和图标区分
   - 显示成功/失败票数的统计结果

5. **任务状态板**
   - 设计直观的任务状态板，展示所有任务的状态
   - 使用明确的视觉标识区分成功/失败任务
   - 突出显示当前任务和下一任务

### 技术要求

1. **保密机制实现**

   - 确保任务卡选择过程的安全性和私密性
   - 防止选择信息提前泄露
   - 处理队员断线重连的状态恢复

2. **实时同步**

   - 实时更新任务执行进度到所有玩家
   - 确保所有玩家同时看到任务结果
   - 处理网络延迟和状态同步问题

3. **动画效果**

   - 实现任务卡的选择和提交动画
   - 设计任务结果的揭示动画
   - 为成功/失败结果设计不同的视觉效果

4. **性能优化**
   - 优化任务执行过程中的网络请求
   - 确保动画效果不影响游戏性能
   - 适配低端设备的性能表现

## 实现步骤

1. **设计任务执行界面布局**

   - 确定任务卡的视觉设计
   - 设计队员信息和任务状态的展示方式
   - 规划任务结果的展示效果

2. **开发队员任务卡选择功能**

   - 实现成功/失败卡选择的交互逻辑
   - 开发任务卡提交和确认机制
   - 实现角色限制（好人只能选成功）

3. **开发非队员等待界面**

   - 实现等待状态的界面和提示
   - 开发任务执行进度的实时显示
   - 设计适当的等待动画

4. **开发结果展示功能**

   - 实现任务结果的计算和判定
   - 开发结果展示的动画和视觉效果
   - 实现任务状态板的更新

5. **优化和测试**
   - 测试不同玩家数量和角色组合下的任务执行
   - 优化动画和交互体验
   - 测试网络异常情况下的行为

## 数据结构

```typescript
// 任务执行数据接口
interface MissionExecution {
  missionNumber: number; // 任务轮次
  teamMembers: TeamMember[]; // 任务队员
  requiredFailures: number; // 任务失败所需票数（通常为1，第4轮特殊规则可能为2）
  cards: MissionCard[]; // 提交的任务卡
  result?: MissionResult; // 任务结果
  timestamp: number; // 创建时间戳
  timeLimit?: number; // 执行时间限制（秒）
}

// 任务卡接口
interface MissionCard {
  playerId: string; // 玩家ID
  playerName: string; // 玩家名称
  isSubmitted: boolean; // 是否已提交
  isSuccess?: boolean; // 是否选择成功（true为成功，false为失败）
  timestamp?: number; // 提交时间戳
}

// 任务结果接口
interface MissionResult {
  isSuccess: boolean; // 任务是否成功
  successCount: number; // 成功票数
  failureCount: number; // 失败票数
  revealedAt: number; // 结果揭示时间戳
}

// 任务历史接口
interface MissionHistory {
  completedMissions: MissionExecution[]; // 已完成的任务
  successCount: number; // 成功任务数
  failureCount: number; // 失败任务数
  currentMission?: number; // 当前进行的任务轮次
}
```

## 界面原型

```
+----------------------------------+
|        第2轮任务 - 执行阶段        |
+----------------------------------+
|                                  |
|  参与任务的队员:                   |
|  +------+  +------+  +------+    |
|  |玩家2  |  |玩家3  |  |玩家6  |    |
|  |      |  |[队长] |  |[你]   |    |
|  +------+  +------+  +------+    |
|                                  |
|  请选择任务卡:                    |
|                                  |
|  +-------------+  +-------------+|
|  |    成功     |  |    失败     ||
|  |   [图标]    |  |   [图标]    ||
|  +-------------+  +-------------+|
|                                  |
|  提交进度: 2/3 已提交             |
|                                  |
|  任务状态:                        |
|  任务1: 成功                      |
|  任务2: 进行中                    |
|  任务3: 未开始                    |
|  任务4: 未开始                    |
|  任务5: 未开始                    |
|                                  |
+----------------------------------+
```

```
+----------------------------------+
|        第2轮任务 - 执行阶段        |
+----------------------------------+
|                                  |
|  参与任务的队员:                   |
|  +------+  +------+  +------+    |
|  |玩家2  |  |玩家3  |  |玩家6  |    |
|  |[已提交]|  |[队长] |  |[待提交]|    |
|  +------+  +------+  +------+    |
|                                  |
|  任务队员正在执行任务              |
|  请耐心等待...                    |
|                                  |
|  [等待动画: 沙漏/时钟]            |
|                                  |
|  提交进度: 2/3 已提交             |
|                                  |
|  任务状态:                        |
|  任务1: 成功                      |
|  任务2: 进行中                    |
|  任务3: 未开始                    |
|  任务4: 未开始                    |
|  任务5: 未开始                    |
|                                  |
+----------------------------------+
```

```
+----------------------------------+
|        第2轮任务 - 结果公布        |
+----------------------------------+
|                                  |
|  [大型结果图标: 失败]              |
|                                  |
|  任务失败!                        |
|                                  |
|  成功票数: 2                      |
|  失败票数: 1                      |
|                                  |
|  参与任务的队员:                   |
|  +------+  +------+  +------+    |
|  |玩家2  |  |玩家3  |  |玩家6  |    |
|  |      |  |[队长] |  |      |    |
|  +------+  +------+  +------+    |
|                                  |
|  任务状态更新:                    |
|  任务1: 成功                      |
|  任务2: 失败 ← 新结果             |
|  任务3: 未开始                    |
|  任务4: 未开始                    |
|  任务5: 未开始                    |
|                                  |
|  [继续游戏]                       |
+----------------------------------+
```

```
+----------------------------------+
|        好人阵营视角 - 任务卡选择    |
+----------------------------------+
|                                  |
|  你是好人阵营                     |
|                                  |
|  请选择任务卡:                    |
|                                  |
|  +-------------+  +-------------+|
|  |    成功     |  |    失败     ||
|  |   [图标]    |  |  [禁用图标]  ||
|  |  [高亮边框] |  |   [灰色]    ||
|  +-------------+  +-------------+|
|                                  |
|  提示: 作为好人阵营，你只能选择成功  |
|                                  |
|  [确认选择]                       |
+----------------------------------+
```

## 任务执行界面（文本描述）

任务执行界面是阿瓦隆游戏中队员秘密决定任务成败的关键环节，设计遵循保密性、紧张感和清晰反馈的原则：

1. **队员视角 - 选择阶段**：

   - 界面顶部显示当前任务轮次和阶段信息（如"第 2 轮任务 - 执行阶段"）
   - 中央上方展示参与任务的队员，当前玩家有特殊标识
   - 中央显示两张大型任务卡：成功（蓝色）和失败（红色）
   - 好人阵营玩家的失败卡呈灰色禁用状态，并有提示"作为好人阵营，你只能选择成功"
   - 坏人阵营玩家可以自由选择成功或失败卡
   - 选中卡片后有明显的选中状态（如卡片放大、发光）
   - 底部有"确认选择"按钮，点击后提交任务卡

2. **非队员视角 - 等待阶段**：

   - 界面显示"任务队员正在执行任务"的提示
   - 展示参与任务的队员头像，已提交任务卡的队员头像有特殊标识
   - 显示提交进度（如"2/3 已提交"）
   - 设计精美的等待动画，如翻转的沙漏或旋转的圆环
   - 底部显示任务状态板，展示历史任务结果

3. **结果展示 - 所有玩家**：

   - 所有队员完成选择后，有短暂的紧张等待动画
   - 结果揭示时，屏幕中央出现大型结果标识
   - 成功时，显示金色/蓝色"任务成功"标识，播放胜利音效
   - 失败时，显示红色/黑色"任务失败"标识，播放失败音效
   - 显示票数统计（如"2 成功/1 失败 - 任务失败！"）
   - 任务状态板自动更新，显示最新任务结果

4. **视觉设计**：

   - 整体使用中世纪风格的 UI 元素，如羊皮纸质感背景
   - 成功卡使用蓝色/金色调，有光芒效果
   - 失败卡使用红色/黑色调，有阴影效果
   - 任务状态板设计为古老的卷轴或石板样式
   - 成功任务用蓝色宝石或金色徽章标记
   - 失败任务用红色宝石或黑色徽章标记

5. **交互反馈**：
   - 选择任务卡时有轻微的触感反馈
   - 提交任务卡后，卡片有"封印"效果
   - 等待他人提交时，显示精美的动画效果
   - 结果揭示时，有渐进式的动画展示
   - 任务状态板更新时有醒目的视觉提示

通过这些设计元素，任务执行界面不仅能确保游戏机制的保密性和公平性，还能通过精心设计的视觉和交互效果增强游戏的紧张感和戏剧性，使玩家充分投入到阿瓦隆的世界中。

## 验收标准

1. **功能完整性**

   - 任务队员能够成功选择和提交任务卡
   - 好人阵营只能选择成功卡，坏人阵营可以自由选择
   - 任务提交状态实时更新，所有玩家能看到提交进度
   - 任务结果正确计算并展示给所有玩家

2. **界面体验**

   - 任务卡设计美观，选择操作直观
   - 队员信息和任务状态展示清晰
   - 任务结果有明确的视觉和音效反馈
   - 任务状态板清晰展示历史任务结果
   - 在不同尺寸的设备上显示正常

3. **交互流畅性**

   - 任务卡选择操作响应迅速，无明显延迟
   - 动画效果流畅，不出现卡顿
   - 状态更新及时，所有玩家看到一致的信息
   - 网络延迟情况下有适当的加载提示

4. **安全性和公平性**
   - 任务卡选择过程保密，结果公布前不泄露他人选择
   - 防止选择作弊或多次提交
   - 断线重连后能恢复正确的任务状态
   - 所有玩家同时看到任务结果

## 技术依赖

- PIXI.js 渲染引擎
- GSAP 动画库
- Socket.IO 客户端（实时通信）
- 游戏状态管理模块
- 加密通信模块（确保任务卡选择安全）

## 工作量估计

2 人天

## 相关文档

- [阿瓦隆游戏规则](../../../阿瓦隆游戏规则.md)
- [Story1.3 游戏进行界面 README](../README.md)
- [Story1.3 技术方案](../技术方案.md)
- [Task1.3.3 实现投票界面](./Task1.3.3_实现投票界面.md)
- [Task1.3.5 实现游戏状态和进度展示](./Task1.3.5_实现游戏状态和进度展示.md)
