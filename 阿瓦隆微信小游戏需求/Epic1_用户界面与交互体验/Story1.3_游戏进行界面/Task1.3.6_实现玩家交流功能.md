# Task 1.3.6: 实现玩家交流功能

## 任务描述

设计并实现阿瓦隆游戏中的玩家交流功能，包括实时聊天、表情互动和快捷消息系统，为玩家提供便捷的沟通渠道，增强游戏的社交性和策略讨论的深度。该功能需要在保证游戏公平性的前提下，支持玩家间的有效沟通。

## 详细需求

### 功能需求

1. **实时聊天系统**

   - 支持玩家在游戏过程中发送文字消息
   - 提供全体聊天和特定阶段的限制性聊天（如任务执行阶段禁止聊天）
   - 显示发言者的名称和头像
   - 支持消息历史记录查看

2. **表情互动系统**

   - 提供一组游戏主题的表情/动作
   - 支持玩家向特定玩家或全体玩家发送表情
   - 表情动画显示在玩家头像附近
   - 表情有适当的冷却时间，防止刷屏

3. **快捷消息系统**

   - 提供一组预设的快捷消息，如"我是好人"、"我怀疑他是坏人"等
   - 支持根据当前游戏阶段显示相关的快捷消息
   - 允许玩家自定义和保存常用快捷消息

4. **语音提示**

   - 关键操作和事件有语音提示
   - 支持开关语音提示功能
   - 语音提示有多种语言选项（如中文、英文）

5. **交流状态管理**

   - 在特定游戏阶段（如任务执行）限制或禁用聊天功能
   - 提供"正在输入"状态提示
   - 支持消息已读状态显示（如适用）

6. **聊天界面管理**
   - 支持聊天界面的展开/折叠
   - 新消息提醒（未读消息数量显示）
   - 聊天记录的滚动和查看功能

### 界面要求

1. **聊天区域设计**

   - 设计紧凑而不干扰游戏主界面的聊天区域
   - 支持聊天区域的展开/折叠/调整大小
   - 新消息有醒目但不打扰游戏的提示

2. **消息气泡设计**

   - 区分自己和他人的消息（不同颜色或位置）
   - 消息气泡包含发送者信息和发送时间
   - 支持消息状态显示（发送中、已发送、已读）

3. **表情面板设计**

   - 设计符合游戏主题的表情选择面板
   - 表情分类清晰，易于快速选择
   - 支持最近使用的表情快速访问

4. **快捷消息面板**

   - 设计直观的快捷消息选择界面
   - 根据游戏阶段显示相关的快捷消息
   - 支持自定义快捷消息的编辑界面

5. **输入区域设计**
   - 提供简洁的文字输入区域
   - 支持表情和快捷消息的快速插入
   - 在禁言状态下有明确的视觉反馈

### 技术要求

1. **实时通信**

   - 使用 WebSocket 实现消息的实时传输
   - 确保消息的可靠传递和顺序
   - 处理网络波动情况下的消息同步

2. **性能优化**

   - 优化消息历史记录的加载和显示
   - 控制表情动画的性能消耗
   - 确保聊天功能不影响游戏主体验

3. **安全措施**

   - 实现基本的敏感词过滤
   - 防止消息刷屏和骚扰行为
   - 提供举报不当言论的功能

4. **离线消息处理**
   - 处理玩家断线重连后的消息同步
   - 保存一定时间范围内的历史消息
   - 显示玩家离线期间的重要消息摘要

## 实现步骤

1. **设计聊天界面布局**

   - 确定聊天区域在游戏界面中的位置和大小
   - 设计消息气泡、输入框和功能按钮的样式
   - 规划表情和快捷消息面板的交互方式

2. **开发基础聊天功能**

   - 实现文字消息的发送和接收
   - 开发消息历史记录的存储和显示
   - 实现聊天界面的基本交互（滚动、折叠等）

3. **开发表情系统**

   - 设计和制作游戏主题的表情资源
   - 实现表情选择和发送功能
   - 开发表情动画的显示效果

4. **开发快捷消息系统**

   - 设计预设的快捷消息内容
   - 实现快捷消息的选择和发送
   - 开发自定义快捷消息的编辑功能

5. **实现交流状态管理**

   - 开发基于游戏阶段的聊天限制逻辑
   - 实现"正在输入"状态的显示
   - 开发消息已读状态的处理

6. **优化和测试**
   - 测试不同网络条件下的聊天性能
   - 优化表情和动画效果
   - 进行多人同时聊天的压力测试

## 数据结构

```typescript
// 消息类型枚举
enum MessageType {
  TEXT = "text", // 文字消息
  EMOJI = "emoji", // 表情消息
  QUICK_MESSAGE = "quick", // 快捷消息
  SYSTEM = "system", // 系统消息
}

// 消息状态枚举
enum MessageStatus {
  SENDING = "sending", // 发送中
  SENT = "sent", // 已发送
  DELIVERED = "delivered", // 已送达
  READ = "read", // 已读
  FAILED = "failed", // 发送失败
}

// 消息接口
interface ChatMessage {
  id: string; // 消息ID
  type: MessageType; // 消息类型
  senderId: string; // 发送者ID
  senderName: string; // 发送者名称
  senderAvatar?: string; // 发送者头像
  content: string; // 消息内容
  timestamp: number; // 发送时间戳
  status: MessageStatus; // 消息状态
  targetId?: string; // 目标玩家ID（如适用）
}

// 文字消息接口
interface TextMessage extends ChatMessage {
  type: MessageType.TEXT;
  content: string; // 文字内容
}

// 表情消息接口
interface EmojiMessage extends ChatMessage {
  type: MessageType.EMOJI;
  emojiId: string; // 表情ID
  emojiUrl: string; // 表情资源URL
}

// 快捷消息接口
interface QuickMessage extends ChatMessage {
  type: MessageType.QUICK;
  quickId: string; // 快捷消息ID
  content: string; // 快捷消息内容
}

// 系统消息接口
interface SystemMessage extends ChatMessage {
  type: MessageType.SYSTEM;
  content: string; // 系统消息内容
  level: "info" | "warning" | "error"; // 消息级别
}

// 聊天状态接口
interface ChatState {
  isEnabled: boolean; // 聊天功能是否启用
  unreadCount: number; // 未读消息数量
  typingUsers: string[]; // 正在输入的用户ID
  messages: ChatMessage[]; // 消息历史
  lastReadTimestamp: number; // 最后阅读时间戳
}

// 表情定义接口
interface EmojiDefinition {
  id: string; // 表情ID
  name: string; // 表情名称
  url: string; // 表情资源URL
  animationData?: any; // 动画数据（如适用）
  category: string; // 表情分类
}

// 快捷消息定义接口
interface QuickMessageDefinition {
  id: string; // 快捷消息ID
  content: string; // 消息内容
  gamePhases: string[]; // 适用的游戏阶段
  isCustom: boolean; // 是否为自定义消息
}
```

## 界面原型

```
+------------------------------------------+
|                游戏主界面                 |
|                                          |
|                                          |
|                                          |
|                                          |
+------------------------------------------+
|            聊天区域 [展开]                |
+------------------------------------------+
| 玩家1: 我认为玩家3是梅林                  |
| 玩家2: 我是忠臣，请相信我                 |
| 玩家5: [表情:思考]                        |
| 你: 我怀疑玩家4                          |
| 系统: 投票阶段开始                        |
| 玩家3: 请相信我，我是好人                 |
| 玩家6: 我认为应该拒绝这个队伍              |
| 玩家4: 同意，这个队伍不可信                |
+------------------------------------------+
| [表情] [快捷消息] 输入消息...    [发送]    |
+------------------------------------------+
```

```
+------------------------------------------+
|                游戏主界面                 |
|                                          |
|                                          |
|                                          |
+------------------------------------------+
|              表情选择面板                 |
+------------------------------------------+
| [基础]  [角色]  [动作]  [情绪]  [最近使用] |
+------------------------------------------+
| 😊  😂  🤔  😮  😡  😢  😴  🙄  👍  👎 |
| 🎭  🗡️  👑  🛡️  🔮  🧙‍♂️  🧝‍♀️  🧟‍♂️  🐉  🏰 |
+------------------------------------------+
|            聊天区域 [折叠]                |
+------------------------------------------+
| 玩家1: 我认为玩家3是梅林                  |
| 你: 我怀疑玩家4                          |
+------------------------------------------+
| [表情] [快捷消息] 输入消息...    [发送]    |
+------------------------------------------+
```

```
+------------------------------------------+
|                游戏主界面                 |
|                                          |
|                                          |
|                                          |
+------------------------------------------+
|             快捷消息选择                  |
+------------------------------------------+
| > 我是好人阵营                           |
| > 我认为玩家X是梅林                      |
| > 我怀疑玩家X是坏人                      |
| > 请相信我，我是忠臣                     |
| > 这个队伍组成不合理                     |
| > 我支持这个队伍                         |
| > 我们应该拒绝这个队伍                   |
+------------------------------------------+
| [常用]  [投票相关]  [任务相关]  [自定义]   |
+------------------------------------------+
|            聊天区域 [折叠]                |
+------------------------------------------+
| 玩家1: 我认为玩家3是梅林                  |
| 你: 我怀疑玩家4                          |
+------------------------------------------+
| [表情] [快捷消息] 输入消息...    [发送]    |
+------------------------------------------+
```

```
+------------------------------------------+
|                游戏主界面                 |
|                                          |
|                                          |
|                                          |
+------------------------------------------+
|            聊天区域 [折叠]                |
+------------------------------------------+
| 系统: 任务阶段开始，禁止交流              |
| 系统: 玩家交流功能已暂时禁用              |
| 系统: 等待任务队员执行任务...             |
+------------------------------------------+
| [表情] [快捷消息] 输入消息...    [发送]    |
|        (当前阶段禁止交流)                |
+------------------------------------------+
```

```
+------------------------------------------+
|                游戏主界面                 |
|                                          |
|                                          |
|                                          |
+------------------------------------------+
|            私聊 - 与玩家3                 |
+------------------------------------------+
| 系统: 私聊已开始，仅你和玩家3可见此对话    |
| 你: 我认为玩家5是莫甘娜                   |
| 玩家3: 我同意，他行为很可疑               |
| 你: 我们应该在下一轮投票中拒绝他的队伍     |
| 玩家3: 好的，我会支持你                   |
+------------------------------------------+
| [返回公共聊天]                           |
| [表情] [快捷消息] 输入消息...    [发送]    |
+------------------------------------------+
```

```
+------------------------------------------+
|                游戏主界面                 |
|                                          |
|                                          |
|                                          |
+------------------------------------------+
|            聊天设置                       |
+------------------------------------------+
| 通知设置:                                |
| [✓] 显示系统消息                         |
| [✓] 显示玩家加入/离开提醒                 |
| [✓] 显示阶段变更提醒                     |
| [✓] 消息提示音                           |
|                                          |
| 聊天过滤:                                |
| [✓] 显示表情消息                         |
| [✓] 显示快捷消息                         |
| [ ] 仅显示当前队长和队员消息              |
|                                          |
| 私聊设置:                                |
| [✓] 允许接收私聊                         |
| [ ] 仅接受好友私聊                       |
|                                          |
| [恢复默认设置]            [保存设置]      |
+------------------------------------------+
```

```
+------------------------------------------+
|                游戏主界面                 |
|                                          |
|                                          |
|                                          |
+------------------------------------------+
|            聊天区域 [展开]                |
+------------------------------------------+
| 玩家1: 我认为玩家3是梅林                  |
| 玩家2: 我是忠臣，请相信我                 |
| 玩家5: [表情:思考]                        |
| 玩家7: [语音消息:5秒]                     |
| 系统: 投票阶段开始                        |
| 玩家3: 请相信我，我是好人                 |
| 玩家6: [图片:战术分析]                    |
| 玩家4: 同意，这个队伍不可信                |
+------------------------------------------+
| [表情] [快捷消息] [语音] [图片] [发送]     |
+------------------------------------------+
```

## 玩家交流功能界面（文本描述）

玩家交流功能界面是阿瓦隆游戏中促进玩家互动和策略讨论的重要组成部分，设计遵循便捷、直观和不干扰主游戏体验的原则：

1. **聊天区域**：

   - 位于游戏界面底部，默认显示折叠状态，只显示最新几条消息
   - 可通过上拉手势或点击展开按钮展开完整聊天区域
   - 展开后占据屏幕下方约 1/3 区域，背景半透明，不完全遮挡游戏场景
   - 右上角有折叠按钮和未读消息计数器
   - 新消息到达时，折叠状态下有轻微的提示动画

2. **消息显示区**：

   - 消息按时间顺序从下往上排列，最新消息在底部
   - 自己的消息靠右显示，使用深色背景
   - 他人的消息靠左显示，包含头像和名称，使用浅色背景
   - 系统消息居中显示，使用特殊样式（如虚线边框）
   - 消息气泡包含发送时间（悬停或长按显示详细时间）
   - 支持上下滑动查看历史消息，滑动平滑有弹性效果

3. **输入区域**：

   - 位于聊天区域底部，包含输入框和功能按钮
   - 输入框支持多行文本，自动扩展高度（有最大高度限制）
   - 左侧有表情按钮和快捷消息按钮
   - 右侧有发送按钮，输入为空时禁用
   - 在禁言状态下，输入区显示禁言提示，输入框禁用

4. **表情面板**：

   - 点击表情按钮弹出表情选择面板
   - 表情按主题分类（基础表情、游戏角色表情、动作表情等）
   - 表情以网格形式排列，支持左右滑动切换分类
   - 底部显示最近使用的表情
   - 选择表情后自动关闭面板并发送

5. **快捷消息面板**：

   - 点击快捷消息按钮弹出快捷消息选择面板
   - 快捷消息按游戏阶段和用途分类
   - 当前游戏阶段的相关快捷消息优先显示
   - 底部有"自定义"选项，可添加和编辑个人快捷消息
   - 选择快捷消息后自动关闭面板并发送

6. **表情动画效果**：

   - 发送表情时，表情动画显示在发送者头像附近
   - 表情动画持续 2-3 秒，然后优雅消失
   - 同时收到多个表情时，有序排队显示
   - 表情动画不遮挡关键游戏元素

7. **视觉设计**：

   - 整体使用符合阿瓦隆世界观的中世纪风格
   - 消息气泡使用羊皮纸或卷轴质感
   - 表情设计融合游戏角色特点和中世纪元素
   - 系统消息使用特殊字体和装饰元素
   - 聊天区域的展开/折叠有流畅的动画效果

8. **交互反馈**：
   - 发送消息时有轻微的发送动画
   - 新消息到达有轻微的提示音（可在设置中关闭）
   - 禁言状态下尝试发言有明确的视觉反馈
   - 长按消息可复制内容（如适用）
   - 消息发送失败有重试选项

通过这些设计元素，玩家交流功能既能满足游戏中的策略讨论需求，又能增强游戏的社交性和趣味性，同时保持与游戏整体风格的一致性，不干扰主要游戏体验。

## 验收标准

1. **功能完整性**

   - 玩家能够成功发送和接收文字消息
   - 表情系统正常工作，动画效果流畅
   - 快捷消息系统提供有用的预设消息
   - 聊天限制在特定游戏阶段正确生效
   - 消息历史记录正确保存和显示

2. **界面体验**

   - 聊天界面设计美观，符合游戏整体风格
   - 消息显示清晰，易于区分不同发送者
   - 表情和快捷消息面板布局合理，易于使用
   - 聊天区域的展开/折叠操作流畅
   - 新消息提醒明显但不打扰游戏

3. **交互流畅性**

   - 消息发送和接收无明显延迟
   - 表情动画流畅，不出现卡顿
   - 聊天区域滚动平滑，反应迅速
   - 输入体验良好，无输入延迟
   - 在不同网络条件下保持可用性

4. **技术性能**
   - 聊天功能不影响游戏主体验的性能
   - 表情动画不导致明显的帧率下降
   - 长时间聊天后内存占用合理
   - 断线重连后能正确恢复聊天状态
   - 消息同步机制可靠，不丢失消息

## 技术依赖

- Socket.IO 客户端（实时通信）
- PIXI.js 或 Lottie（表情动画）
- 本地存储模块（历史记录和设置）
- 文本输入优化库（移动设备适配）
- 敏感词过滤模块

## 工作量估计

3 人天

## 相关文档

- [阿瓦隆游戏规则](../../../阿瓦隆游戏规则.md)
- [Story1.3 游戏进行界面 README](../README.md)
- [Story1.3 技术方案](../技术方案.md)
- [Task1.3.5 实现游戏状态和进度展示](./Task1.3.5_实现游戏状态和进度展示.md)
- [Task1.3.7 实现特殊角色能力界面](./Task1.3.7_实现特殊角色能力界面.md)
