# Task 1.3.3: 实现投票界面

## 任务描述

设计并实现阿瓦隆游戏中的投票界面，该界面用于所有玩家对队长提议的任务队伍进行赞成或反对投票。投票环节是游戏中的关键决策点，需要确保投票过程公平、清晰，并为玩家提供良好的交互体验。

## 详细需求

### 功能需求

1. **投票信息展示**

   - 清晰显示当前投票的任务轮次和尝试次数
   - 展示队长和被提议的任务队伍成员
   - 显示当前投票进度（已投票人数/总人数）
   - 提供投票倒计时（如有时间限制）

2. **投票操作**

   - 为玩家提供赞成/反对两个明确的选项
   - 确保投票操作简单直观
   - 投票后显示已投票状态，但不显示具体选择
   - 防止重复投票或修改已提交的投票

3. **投票结果展示**

   - 所有玩家完成投票后，展示总体投票结果
   - 显示每位玩家的投票选择（赞成/反对）
   - 根据多数原则，明确标识投票是否通过
   - 提供投票结果的视觉和音效反馈

4. **投票历史**

   - 记录并展示当前任务轮次的历史投票情况
   - 显示连续拒绝的次数（接近 5 次拒绝时给予警告）
   - 提供查看详细投票历史的入口

5. **状态转换**
   - 投票通过后，自动转入任务执行阶段
   - 投票拒绝后，转入下一次组队（队长轮换）
   - 连续 5 次拒绝后，自动标记当前任务失败并进入下一轮

### 界面要求

1. **投票卡片设计**

   - 设计醒目的赞成/反对投票卡片
   - 赞成卡片使用积极色调（如蓝色/绿色）
   - 反对卡片使用警示色调（如红色/橙色）
   - 卡片上有明确的文字和图标标识

2. **队伍信息展示**

   - 清晰展示当前提议的队伍成员
   - 突出显示队长身份
   - 提供队伍成员的基本信息（头像、名称）

3. **投票状态指示**

   - 为每位玩家提供投票状态指示（未投票/已投票）
   - 使用动画或图标表示投票进行中的状态
   - 结果公布前不显示具体投票选择

4. **结果展示设计**

   - 投票结果使用醒目的视觉效果展示
   - 通过/拒绝状态有明确的色彩和图标区分
   - 每位玩家的投票选择有清晰的视觉表示

5. **响应式布局**
   - 适配不同尺寸的手机屏幕
   - 确保在横屏和竖屏模式下都能正常显示
   - 关键元素（如投票按钮）尺寸合适，易于触控

### 技术要求

1. **投票机制实现**

   - 确保投票过程的安全性和公平性
   - 防止投票信息提前泄露
   - 处理玩家断线重连的投票状态恢复

2. **实时同步**

   - 实时更新投票进度到所有玩家
   - 确保所有玩家同时看到投票结果
   - 处理网络延迟和状态同步问题

3. **动画效果**

   - 实现投票卡片的选择和提交动画
   - 设计投票结果的揭示动画
   - 为通过/拒绝结果设计不同的视觉效果

4. **性能优化**
   - 优化投票过程中的网络请求
   - 确保动画效果不影响游戏性能
   - 适配低端设备的性能表现

## 实现步骤

1. **设计投票界面布局**

   - 确定投票卡片的视觉设计
   - 设计队伍信息和投票状态的展示方式
   - 规划投票结果的展示效果

2. **开发投票操作功能**

   - 实现赞成/反对选择的交互逻辑
   - 开发投票提交和确认机制
   - 实现投票状态的实时更新

3. **开发结果展示功能**

   - 实现投票结果的计算和判定
   - 开发结果展示的动画和视觉效果
   - 实现通过/拒绝后的状态转换

4. **实现投票历史功能**

   - 开发投票历史的数据结构和存储
   - 实现历史记录的展示界面
   - 添加连续拒绝计数和警告功能

5. **优化和测试**
   - 测试不同玩家数量下的投票流程
   - 优化动画和交互体验
   - 测试网络异常情况下的行为

## 数据结构

```typescript
// 投票数据接口
interface VotingSession {
  missionNumber: number; // 任务轮次
  attemptNumber: number; // 尝试次数
  leaderId: string; // 队长ID
  proposedTeam: TeamMember[]; // 提议的队伍
  votes: PlayerVote[]; // 所有玩家的投票
  result?: VotingResult; // 投票结果
  timestamp: number; // 创建时间戳
  timeLimit?: number; // 投票时间限制（秒）
}

// 玩家投票接口
interface PlayerVote {
  playerId: string; // 玩家ID
  playerName: string; // 玩家名称
  hasVoted: boolean; // 是否已投票
  vote?: boolean; // 投票选择（true为赞成，false为反对）
  timestamp?: number; // 投票时间戳
}

// 投票结果接口
interface VotingResult {
  approved: boolean; // 是否通过
  approveCount: number; // 赞成票数
  rejectCount: number; // 反对票数
  revealedAt: number; // 结果揭示时间戳
}

// 投票历史接口
interface VotingHistory {
  missionNumber: number; // 任务轮次
  attempts: VotingSession[]; // 该轮所有投票尝试
  consecutiveRejects: number; // 连续拒绝次数
  finalApprovedTeam?: TeamMember[]; // 最终通过的队伍
}
```

## 界面原型

```
+----------------------------------+
|        第2轮任务 - 投票阶段        |
+----------------------------------+
|                                  |
|  队长玩家3提议的队伍:              |
|  +------+  +------+  +------+    |
|  |玩家2  |  |玩家3  |  |玩家6  |    |
|  |      |  |[队长] |  |      |    |
|  +------+  +------+  +------+    |
|                                  |
|  请对此队伍进行投票:               |
|                                  |
|  +-------------+  +-------------+|
|  |    赞成     |  |    反对     ||
|  |   [图标]    |  |   [图标]    ||
|  +-------------+  +-------------+|
|                                  |
|  投票进度: 4/6 已投票             |
|  倒计时: 15秒                     |
|                                  |
|  玩家状态:                        |
|  玩家1: 已投票  玩家2: 已投票      |
|  玩家3: 已投票  玩家4: 未投票      |
|  玩家5: 已投票  玩家6: 未投票      |
|                                  |
|  [查看历史投票]                   |
|                                  |
+----------------------------------+
```

```
+----------------------------------+
|        第2轮任务 - 投票结果        |
+----------------------------------+
|                                  |
|  队长玩家3提议的队伍:              |
|  +------+  +------+  +------+    |
|  |玩家2  |  |玩家3  |  |玩家6  |    |
|  |      |  |[队长] |  |      |    |
|  +------+  +------+  +------+    |
|                                  |
|  投票结果: 拒绝                   |
|  赞成: 2票 / 反对: 4票            |
|                                  |
|  玩家投票详情:                    |
|  +------+  +------+  +------+    |
|  |玩家1  |  |玩家2  |  |玩家3  |    |
|  |[反对] |  |[赞成] |  |[赞成] |    |
|  +------+  +------+  +------+    |
|  +------+  +------+  +------+    |
|  |玩家4  |  |玩家5  |  |玩家6  |    |
|  |[反对] |  |[反对] |  |[反对] |    |
|  +------+  +------+  +------+    |
|                                  |
|  连续拒绝: 2/5                    |
|                                  |
|  [继续]                          |
+----------------------------------+
```

```
+----------------------------------+
|           投票历史记录            |
+----------------------------------+
|                                  |
|  任务2 - 投票历史:                |
|                                  |
|  第1次尝试 (拒绝):                |
|  队长: 玩家1                      |
|  队员: 玩家1, 玩家3, 玩家5        |
|  结果: 2赞成 / 4反对              |
|                                  |
|  第2次尝试 (拒绝):                |
|  队长: 玩家3                      |
|  队员: 玩家2, 玩家3, 玩家6        |
|  结果: 2赞成 / 4反对              |
|                                  |
|  [返回]                          |
+----------------------------------+
```

```
+----------------------------------+
|           投票警告提示            |
+----------------------------------+
|                                  |
|  ⚠️ 警告 ⚠️                      |
|                                  |
|  已连续拒绝4次队伍!               |
|                                  |
|  如果第5次投票仍被拒绝，           |
|  本轮任务将自动失败!              |
|                                  |
|  [我已了解]                      |
+----------------------------------+
```

## 投票界面（文本描述）

投票界面是阿瓦隆游戏中所有玩家对队长提议队伍进行决策的关键环节，设计遵循公平、清晰、紧张感的原则：

1. **投票前展示**：

   - 界面顶部显示当前任务轮次和阶段信息（如"第 2 轮任务 - 投票阶段"）
   - 中央上方展示队长提议的队伍，队长头像有特殊标识
   - 队伍成员以头像+名称的形式排列展示
   - 显示当前是第几次尝试组队（如"第 2 次尝试"）
   - 如接近自动失败（连续 4 次拒绝），显示警告提示

2. **投票操作区**：

   - 中央显示两张大型投票卡片：赞成（蓝色）和反对（红色）
   - 卡片上有明确的文字和图标（赞成为拇指向上，反对为拇指向下）
   - 卡片有轻微的悬浮效果，鼓励交互
   - 选中卡片后有明显的选中状态（如卡片放大、发光）
   - 底部有"确认投票"按钮，点击后提交选择

3. **投票状态区**：

   - 显示当前投票进度（如"4/6 已投票"）
   - 列出所有玩家的投票状态（已投票/未投票）
   - 自己的投票状态特别标注
   - 如有时间限制，显示倒计时计时器
   - 投票完成前不显示任何人的具体投票选择

4. **结果展示**：

   - 所有玩家完成投票后，有短暂的紧张等待动画
   - 结果揭示时，所有投票卡片同时翻转展示
   - 通过时，屏幕闪烁绿色光效，播放成功音效
   - 拒绝时，屏幕闪烁红色光效，播放失败音效
   - 显示最终票数统计（如"4 赞成/2 反对 - 通过！"）

5. **视觉设计**：

   - 整体使用中世纪风格的 UI 元素
   - 投票卡片设计精美，有纹理和浮雕效果
   - 赞成卡片使用蓝色/金色调，象征正义和忠诚
   - 反对卡片使用红色/黑色调，象征怀疑和警惕
   - 结果展示使用动态效果，增强戏剧性

6. **交互反馈**：
   - 选择卡片时有轻微的触感反馈（如震动）
   - 提交投票后，选中的卡片有"盖章"效果
   - 等待他人投票时，显示精美的沙漏或时钟动画
   - 结果揭示时，所有卡片同时翻转的动画效果
   - 通过/拒绝结果有不同的音效和视觉反馈

通过这些设计元素，投票界面不仅能清晰展示当前状态和所需操作，还能通过精心设计的视觉和交互效果增强游戏的紧张感和决策的重要性，使玩家充分投入到阿瓦隆的世界中。

## 验收标准

1. **功能完整性**

   - 所有玩家能够成功进行赞成/反对投票
   - 投票状态实时更新，所有玩家能看到投票进度
   - 投票结果正确计算并展示给所有玩家
   - 连续拒绝计数正确，达到 5 次时自动失败

2. **界面体验**

   - 投票卡片设计美观，选择操作直观
   - 队伍信息和投票状态展示清晰
   - 投票结果有明确的视觉和音效反馈
   - 在不同尺寸的设备上显示正常

3. **交互流畅性**

   - 投票操作响应迅速，无明显延迟
   - 动画效果流畅，不出现卡顿
   - 状态更新及时，所有玩家看到一致的信息
   - 网络延迟情况下有适当的加载提示

4. **安全性和公平性**
   - 投票过程保密，结果公布前不泄露他人选择
   - 防止投票作弊或多次投票
   - 断线重连后能恢复正确的投票状态
   - 所有玩家同时看到投票结果

## 技术依赖

- PIXI.js 渲染引擎
- GSAP 动画库
- Socket.IO 客户端（实时通信）
- 游戏状态管理模块
- 加密通信模块（确保投票安全）

## 工作量估计

2 人天

## 相关文档

- [阿瓦隆游戏规则](../../../阿瓦隆游戏规则.md)
- [Story1.3 游戏进行界面 README](../README.md)
- [Story1.3 技术方案](../技术方案.md)
- [Task1.3.2 实现任务组队界面](./Task1.3.2_实现任务组队界面.md)
- [Task1.3.4 实现任务执行界面](./Task1.3.4_实现任务执行界面.md)
