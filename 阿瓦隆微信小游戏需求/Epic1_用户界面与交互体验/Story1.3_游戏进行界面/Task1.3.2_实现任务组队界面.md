# Task 1.3.2: 实现任务组队界面

## 任务描述

设计并实现阿瓦隆游戏中的任务组队界面，该界面用于当前队长选择玩家组成任务队伍。任务组队是游戏的核心环节之一，需要清晰展示当前队长、可选玩家、已选队员，并提供直观的交互方式。

## 详细需求

### 功能需求

1. **队长指示**

   - 明确标识当前担任队长的玩家
   - 显示队长选择队员的提示信息
   - 如果当前用户是队长，提供明确的操作指引

2. **队员选择**

   - 队长可以从所有玩家中选择指定数量的队员
   - 显示当前任务所需的队员数量
   - 提供选择/取消选择玩家的交互方式
   - 显示已选择的队员数量和剩余可选数量

3. **队伍确认**

   - 队长完成选择后可以确认队伍
   - 确认前进行队伍有效性验证（如队员数量是否正确）
   - 确认后向所有玩家展示最终队伍组成

4. **非队长视角**

   - 非队长玩家可以看到队长正在选择队员的状态
   - 显示队长已选择的队员（如果游戏规则允许）
   - 提供适当的等待提示和视觉反馈

5. **历史记录**
   - 显示之前轮次的队伍组成历史
   - 标记历史队伍的投票结果（通过/拒绝）
   - 提供查看详细历史的入口

### 界面要求

1. **队长标识**

   - 队长头像周围添加醒目的视觉标识（如皇冠图标）
   - 队长名称使用特殊颜色或样式突出显示
   - 添加"当前队长"的文字提示

2. **玩家选择区域**

   - 以网格或环形布局展示所有玩家头像
   - 已选玩家有明确的选中状态视觉反馈
   - 不可选状态（如已达到最大选择数）有明确视觉区分
   - 当前用户的头像有特殊标识

3. **队伍预览区域**

   - 显示当前已选队员的头像和名称
   - 显示当前任务轮次和所需队员数量
   - 提供清晰的进度指示（如"已选择 3/5 名队员"）

4. **确认按钮**

   - 队长视角下，提供醒目的确认按钮
   - 按钮状态反映当前选择是否有效（如队员数量不足时禁用）
   - 确认操作有明确的视觉和音效反馈

5. **等待提示**
   - 非队长玩家看到适当的等待动画
   - 显示"队长正在选择队员"的状态提示
   - 可选择性地显示倒计时（如有时间限制）

### 技术要求

1. **交互实现**

   - 实现流畅的点击/触摸选择交互
   - 选择/取消选择有即时的视觉反馈
   - 支持拖拽选择（可选增强功能）

2. **状态同步**

   - 实时同步队长选择状态到所有玩家
   - 处理网络延迟和断线重连情况
   - 确保所有玩家看到一致的队伍信息

3. **动画效果**

   - 实现队员选择/取消的动画效果
   - 队伍确认后的过渡动画
   - 队长标识的强调动画

4. **性能优化**
   - 优化多玩家头像的渲染性能
   - 减少不必要的网络请求和状态更新
   - 确保在低端设备上也有流畅体验

## 实现步骤

1. **设计界面布局和交互流程**

   - 确定队长视角和普通玩家视角的界面布局
   - 设计玩家选择的交互方式和视觉反馈
   - 设计队伍确认流程和动画效果

2. **开发队长功能**

   - 实现队长标识和提示信息
   - 开发玩家选择/取消选择的交互逻辑
   - 实现队伍确认和验证功能

3. **开发普通玩家视角**

   - 实现等待状态的界面和提示
   - 开发队伍组成的实时显示
   - 实现队伍确认后的状态更新

4. **实现历史记录功能**

   - 开发历史队伍的数据结构和存储
   - 实现历史记录的展示界面
   - 添加历史队伍的标记和筛选功能

5. **优化和测试**
   - 测试不同玩家数量下的界面表现
   - 优化动画和交互体验
   - 测试网络异常情况下的行为

## 数据结构

```typescript
// 任务队伍数据接口
interface MissionTeam {
  missionNumber: number; // 任务轮次
  attemptNumber: number; // 尝试次数（第几次组队）
  leaderId: string; // 队长ID
  leaderName: string; // 队长名称
  requiredTeamSize: number; // 所需队员数量
  selectedMembers: TeamMember[]; // 已选队员
  status: TeamStatus; // 队伍状态
  timestamp: number; // 创建时间戳
}

// 队员信息接口
interface TeamMember {
  playerId: string; // 玩家ID
  playerName: string; // 玩家名称
  avatarUrl: string; // 头像URL
  selectionOrder: number; // 选择顺序
}

// 队伍状态枚举
enum TeamStatus {
  SELECTING = "selecting", // 队长正在选择
  PROPOSED = "proposed", // 队伍已提议，等待投票
  APPROVED = "approved", // 投票通过
  REJECTED = "rejected", // 投票拒绝
}

// 队伍历史记录接口
interface TeamHistory {
  missionNumber: number; // 任务轮次
  attempts: MissionTeam[]; // 该轮所有尝试的队伍
  finalTeam?: MissionTeam; // 最终执行任务的队伍
  missionResult?: boolean; // 任务结果（成功/失败）
}
```

## 界面原型

```
+------------------------------------------+
|        第2轮任务 - 组队阶段 (队长视角)    |
+------------------------------------------+
|                                          |
|  你是当前队长，请选择3名队员执行任务      |
|  已选择: 1/3                             |
|                                          |
|  所有玩家:                               |
|  +------+  +------+  +------+  +------+  |
|  |玩家1  |  |玩家2  |  |玩家3  |  |玩家4  |  |
|  |[你]   |  |      |  |[已选] |  |      |  |
|  |[队长] |  |      |  |      |  |      |  |
|  +------+  +------+  +------+  +------+  |
|                                          |
|  +------+  +------+  +------+  +------+  |
|  |玩家5  |  |玩家6  |  |玩家7  |  |玩家8  |  |
|  |      |  |      |  |      |  |      |  |
|  |      |  |      |  |      |  |      |  |
|  +------+  +------+  +------+  +------+  |
|                                          |
|  已选队员:                               |
|  +------+  +------+                     |
|  |玩家1  |  |玩家3  |                     |
|  |[你]   |  |      |                     |
|  +------+  +------+                     |
|                                          |
|  [查看历史]                 [确认队伍]    |
+------------------------------------------+
```

```
+------------------------------------------+
|      第2轮任务 - 组队阶段 (玩家视角)      |
+------------------------------------------+
|                                          |
|  玩家1(队长)正在选择队员                  |
|  需要选择: 3名队员                        |
|                                          |
|  所有玩家:                               |
|  +------+  +------+  +------+  +------+  |
|  |玩家1  |  |玩家2  |  |玩家3  |  |玩家4  |  |
|  |[队长] |  |      |  |[已选] |  |      |  |
|  |[已选] |  |      |  |      |  |      |  |
|  +------+  +------+  +------+  +------+  |
|                                          |
|  +------+  +------+  +------+  +------+  |
|  |玩家5  |  |玩家6  |  |玩家7  |  |玩家8  |  |
|  |      |  |      |  |      |  |[你]   |  |
|  |      |  |      |  |      |  |      |  |
|  +------+  +------+  +------+  +------+  |
|                                          |
|  已选队员:                               |
|  +------+  +------+                     |
|  |玩家1  |  |玩家3  |                     |
|  |[队长] |  |      |                     |
|  +------+  +------+                     |
|                                          |
|  [查看历史]                              |
+------------------------------------------+
```

```
+------------------------------------------+
|             历史队伍记录                  |
+------------------------------------------+
|                                          |
|  任务1 (成功):                           |
|  队长: 玩家8                             |
|  队员: 玩家2, 玩家5, 玩家8               |
|  投票结果: 6赞成 / 2反对                  |
|                                          |
|  任务2 - 第1次尝试 (拒绝):                |
|  队长: 玩家1                             |
|  队员: 玩家1, 玩家3, 玩家6               |
|  投票结果: 3赞成 / 5反对                  |
|                                          |
|  [返回]                                  |
+------------------------------------------+
```

```
+------------------------------------------+
|             队伍确认                      |
+------------------------------------------+
|                                          |
|  你确定要派遣以下队员执行任务吗？          |
|                                          |
|  +------+  +------+  +------+           |
|  |玩家1  |  |玩家3  |  |玩家6  |           |
|  |[你]   |  |      |  |      |           |
|  |[队长] |  |      |  |      |           |
|  +------+  +------+  +------+           |
|                                          |
|  确认后，所有玩家将对此队伍进行投票        |
|                                          |
|  [取消]                    [确认]         |
+------------------------------------------+
```

## 任务组队界面（文本描述）

任务组队界面是阿瓦隆游戏中队长选择任务队员的关键环节，设计遵循清晰、直观、高效的原则：

1. **队长视角**：

   - 界面顶部显示当前任务轮次和阶段信息（如"第 2 轮任务 - 组队阶段"）
   - 队长头像周围有金色皇冠动画效果，并标注"当前队长"
   - 中央区域以网格形式展示所有玩家头像和名称
   - 玩家头像可点击选择，选中后头像边框变为金色并显示勾选标记
   - 已达到所需队员数量后，其他未选玩家头像变为半透明不可选状态
   - 底部显示已选队员预览区，实时更新选择结果
   - 右下角有醒目的"确认队伍"按钮，队员数量不足时呈灰色禁用状态

2. **普通玩家视角**：

   - 界面布局与队长视角相似，但玩家头像不可交互
   - 顶部显示"玩家 X 正在选择队员"的提示
   - 如果游戏设置允许，可实时看到队长的选择过程
   - 否则显示"队长正在选择队员，请耐心等待"和加载动画
   - 底部显示历史记录按钮，可查看之前轮次的队伍组成

3. **视觉设计**：

   - 使用中世纪风格的 UI 元素，如羊皮纸质感的背景
   - 队长标识使用金色皇冠图标，有微小的闪光动画
   - 选中效果使用金色边框和柔和的光晕
   - 确认按钮使用醒目的绿色，取消按钮使用红色
   - 历史记录使用卷轴图标表示

4. **交互反馈**：

   - 点击选择玩家时有轻微放大和音效反馈
   - 达到所需队员数量时，确认按钮从灰色变为亮色并有轻微跳动动画
   - 确认队伍后，所有已选队员头像同时放大并向中心聚集，过渡到投票界面
   - 取消选择时，队员头像有淡出动画效果

5. **历史记录展示**：
   - 点击历史记录按钮弹出侧边栏或底部抽屉
   - 按任务轮次分组显示历史队伍组成
   - 通过的队伍标记绿色对勾，拒绝的队伍标记红色叉
   - 每个历史记录显示队长和队员信息，以及投票结果

通过这些设计元素，任务组队界面不仅能清晰展示当前状态和所需操作，还能通过精心设计的视觉和交互效果增强游戏体验，使玩家沉浸在阿瓦隆的世界观中。

## 验收标准

1. **功能完整性**

   - 队长能够成功选择和取消选择玩家
   - 正确限制队员选择数量，符合当前任务要求
   - 队伍确认功能正常工作，并正确同步到所有玩家
   - 历史记录功能可正确显示之前轮次的队伍组成

2. **界面体验**

   - 队长标识清晰可见，所有玩家能够识别当前队长
   - 玩家选择状态有明确的视觉反馈
   - 界面布局合理，信息展示清晰
   - 在不同尺寸的设备上显示正常

3. **交互流畅性**

   - 选择/取消选择操作响应迅速
   - 动画效果流畅，不出现卡顿
   - 状态更新及时，所有玩家看到一致的信息
   - 网络延迟情况下有适当的加载提示

4. **异常处理**
   - 队长断线后能够正确处理（如转移队长权限或等待重连）
   - 网络波动情况下不会导致数据不一致
   - 提供适当的错误提示和恢复机制

## 技术依赖

- PIXI.js 渲染引擎
- GSAP 动画库
- Socket.IO 客户端（实时通信）
- 游戏状态管理模块

## 工作量估计

2 人天

## 相关文档

- [阿瓦隆游戏规则](../../../阿瓦隆游戏规则.md)
- [Story1.3 游戏进行界面 README](../README.md)
- [Story1.3 技术方案](../技术方案.md)
- [Task1.3.1 设计并实现角色信息展示界面](./Task1.3.1_设计并实现角色信息展示界面.md)
- [Task1.3.3 实现投票界面](./Task1.3.3_实现投票界面.md)
