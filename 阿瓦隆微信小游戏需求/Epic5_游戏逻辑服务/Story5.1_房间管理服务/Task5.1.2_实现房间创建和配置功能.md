# Task 5.1.2: 实现房间创建和配置功能

## 描述

实现游戏房间的创建和配置功能，使玩家能够创建新的游戏房间，并根据需要配置游戏规则和角色分配。该模块需要提供友好的 API 接口，并确保房间创建过程的安全性和稳定性。

## 验收标准

1. 提供 REST API 和 WebSocket 接口用于创建房间
2. 实现房间号生成逻辑，确保唯一性和安全性
3. 支持玩家设置房间基本参数（玩家人数、角色配置等）
4. 实现默认游戏配置的自动生成，基于玩家选择的人数
5. 提供房间设置更新功能，允许房主在游戏开始前修改配置
6. 实现房间元数据记录，包括创建时间、创建者等信息
7. 所有 API 接口响应时间不超过 200ms（95%分位数）

## 详细任务

### 1. 创建房间 API 实现

- 设计并实现创建房间的 REST API
- 实现创建房间的 WebSocket 事件处理
- 添加请求验证和参数校验逻辑
- 实现房间创建权限检查

### 2. 房间号生成系统

- 实现 6 位数字房间号生成算法
- 确保房间号唯一性（采用 Redis 实现冲突检测）
- 实现房间号复用策略（关闭房间后何时可复用）
- 防止可预测的房间号生成

### 3. 房间配置功能

- 实现游戏基本配置设置（玩家人数限制）
- 实现角色配置设置（根据阿瓦隆规则）
- 对于 5-10 人不同人数，提供默认角色配置
- 支持自定义角色配置（可选）

### 4. 更新房间设置

- 实现更新房间设置的 API
- 添加权限控制（仅房主可更改）
- 实现设置变更的实时通知
- 确保设置更新的原子性

### 5. 房间元数据管理

- 记录房间创建时间、创建者信息
- 实现房间状态跟踪（活跃时间等）
- 设计并实现房间统计信息收集
- 提供房间元数据查询接口

## 技术关键点

1. 采用高效的房间号生成算法，避免冲突和预测性
2. 使用 Redis 实现房间号唯一性检查和分配
3. 设计合理的默认游戏配置，符合阿瓦隆规则
4. 实现基于 WebSocket 的实时通知机制
5. 针对高并发创建请求进行优化设计

## 工作量估计

- 创建房间 API 实现：1.5 人天
- 房间号生成系统：1 人天
- 房间配置功能：2 人天
- 更新房间设置：1 人天
- 房间元数据管理：0.5 人天

总计：6 人天

## 相关文档

- [房间管理服务技术方案](../技术方案.md)
- [阿瓦隆游戏规则](../../../阿瓦隆游戏规则.md)

## 默认角色配置参考

| 玩家人数 | 好人数量 | 坏人数量 | 推荐角色配置                                           |
| -------- | -------- | -------- | ------------------------------------------------------ |
| 5 人     | 3 人     | 2 人     | 梅林、派西维尔、忠臣、刺客、莫甘娜                     |
| 6 人     | 4 人     | 2 人     | 梅林、派西维尔、2 忠臣、刺客、莫甘娜                   |
| 7 人     | 4 人     | 3 人     | 梅林、派西维尔、2 忠臣、刺客、莫甘娜、莫德雷德         |
| 8 人     | 5 人     | 3 人     | 梅林、派西维尔、3 忠臣、刺客、莫甘娜、莫德雷德         |
| 9 人     | 6 人     | 3 人     | 梅林、派西维尔、4 忠臣、刺客、莫甘娜、莫德雷德         |
| 10 人    | 6 人     | 4 人     | 梅林、派西维尔、4 忠臣、刺客、莫甘娜、莫德雷德、奥伯伦 |
