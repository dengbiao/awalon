# 阿瓦隆游戏核心逻辑测试计划

## 1. 概述

本测试计划旨在确保阿瓦隆游戏核心逻辑服务的各项功能正常运行，包括游戏状态管理、角色分配、组队和投票系统、任务执行系统以及刺客阶段与游戏结束处理等核心功能。通过全面的测试，确保游戏流程完整、规则正确、数据一致，并能够提供良好的用户体验。

## 2. 测试范围

本测试计划覆盖以下功能模块：

- 游戏状态和流程管理（Task 5.2.1）
- 角色分配与管理（Task 5.2.2）
- 组队和投票系统（Task 5.2.3）
- 任务执行系统（Task 5.2.4）
- 刺客阶段与游戏结束处理（Task 5.2.5）

## 3. 测试环境

### 3.1 测试环境配置

- **开发环境**：Node.js 服务器，TypeScript 开发环境
- **测试数据库**：MongoDB 测试实例，Redis 测试实例
- **测试工具**：Jest 测试框架，Supertest HTTP 测试工具
- **模拟客户端**：WebSocket 客户端模拟工具

### 3.2 测试账号

- 创建至少 10 个测试账号，用于模拟不同玩家
- 准备至少 3 个测试房间，用于不同场景测试

## 4. 测试策略

### 4.1 测试类型

- **单元测试**：测试各个组件和函数的独立功能
- **集成测试**：测试组件之间的交互和数据流
- **端到端测试**：模拟真实游戏流程的完整测试
- **性能测试**：测试系统在不同负载下的性能表现
- **安全测试**：测试系统的安全性和防作弊能力

### 4.2 测试优先级

- **P0**：关键功能，必须通过才能发布
- **P1**：重要功能，严重影响用户体验
- **P2**：普通功能，影响用户体验但有替代方案
- **P3**：次要功能，不影响核心游戏体验

## 5. 测试用例

### 5.1 游戏状态和流程管理测试

#### 5.1.1 游戏创建与初始化（P0）

1. **测试场景**：创建新游戏

   - 输入：房间 ID、玩家列表、游戏配置
   - 预期结果：游戏创建成功，状态为 INITIALIZING

2. **测试场景**：游戏状态转换

   - 输入：触发不同状态转换的事件
   - 预期结果：状态正确转换，符合状态机定义

3. **测试场景**：非法状态转换
   - 输入：触发非法的状态转换
   - 预期结果：抛出错误，状态不发生变化

#### 5.1.2 游戏配置验证（P1）

1. **测试场景**：不同玩家人数的任务配置

   - 输入：5-10 人不同配置的游戏
   - 预期结果：任务要求符合规则定义

2. **测试场景**：异常配置处理
   - 输入：错误的游戏配置
   - 预期结果：返回适当的错误信息

#### 5.1.3 游戏状态持久化和恢复（P1）

1. **测试场景**：游戏状态保存

   - 输入：游戏进行中的状态
   - 预期结果：状态正确保存到数据库

2. **测试场景**：游戏状态恢复
   - 输入：从数据库加载的游戏状态
   - 预期结果：游戏状态正确恢复，可以继续进行

### 5.2 角色分配与管理测试

#### 5.2.1 角色分配算法（P0）

1. **测试场景**：随机角色分配

   - 输入：玩家列表和角色配置
   - 预期结果：角色分配符合配置要求，每个玩家分配一个角色

2. **测试场景**：角色阵营平衡
   - 输入：不同玩家人数的游戏
   - 预期结果：好人和坏人阵营的比例符合游戏规则

#### 5.2.2 角色信息可见性（P0）

1. **测试场景**：梅林可见性测试

   - 输入：梅林角色查询其他玩家信息
   - 预期结果：可以看到所有坏人（除莫德雷德）

2. **测试场景**：派西维尔可见性测试

   - 输入：派西维尔角色查询其他玩家信息
   - 预期结果：可以看到梅林和莫甘娜（但无法区分）

3. **测试场景**：莫德雷德可见性测试
   - 输入：莫德雷德角色查询其他玩家信息
   - 预期结果：可以看到所有坏人，但梅林看不到莫德雷德

#### 5.2.3 角色信息安全性（P1）

1. **测试场景**：非法角色信息访问

   - 输入：尝试访问不应该看到的角色信息
   - 预期结果：访问被拒绝，返回错误信息

2. **测试场景**：角色信息加密验证
   - 输入：验证角色信息传输是否加密
   - 预期结果：信息经过加密，无法通过网络分析获取明文信息

### 5.3 组队和投票系统测试

#### 5.3.1 队长轮换机制（P0）

1. **测试场景**：初始队长分配

   - 输入：游戏开始
   - 预期结果：随机选择一名玩家作为初始队长

2. **测试场景**：队长轮换
   - 输入：投票拒绝后
   - 预期结果：队长标记移至下一位玩家

#### 5.3.2 组队功能（P0）

1. **测试场景**：队长选择队员

   - 输入：队长选择指定数量的队员
   - 预期结果：队伍组建成功，进入投票阶段

2. **测试场景**：队伍人数验证
   - 输入：队长选择不符合要求数量的队员
   - 预期结果：返回错误，要求重新选择

#### 5.3.3 投票系统（P0）

1. **测试场景**：所有玩家投票

   - 输入：所有玩家提交赞成或反对票
   - 预期结果：正确统计票数，并根据多数结果决定下一步

2. **测试场景**：投票超时处理

   - 输入：部分玩家未在规定时间内投票
   - 预期结果：系统处理超时情况，游戏正常继续

3. **测试场景**：连续拒绝处理
   - 输入：连续 5 次投票拒绝
   - 预期结果：当前轮次自动失败，进入下一轮

### 5.4 任务执行系统测试

#### 5.4.1 任务选择提交（P0）

1. **测试场景**：好人提交任务选择

   - 输入：好人角色提交"成功"选项
   - 预期结果：选择被接受，记录为成功

2. **测试场景**：坏人提交任务选择

   - 输入：坏人角色提交"失败"选项
   - 预期结果：选择被接受，记录为失败

3. **测试场景**：角色限制验证
   - 输入：好人角色尝试提交"失败"选项
   - 预期结果：操作被拒绝，返回错误信息

#### 5.4.2 任务结果计算（P0）

1. **测试场景**：普通轮次结果计算

   - 输入：任务队员提交的选择（包含至少一个失败）
   - 预期结果：任务失败

2. **测试场景**：第四轮特殊规则测试（7 人以上游戏）
   - 输入：任务队员提交的选择（包含 1 个失败）
   - 预期结果：任务成功（需要至少 2 个失败才会失败）

#### 5.4.3 任务结果保密性（P1）

1. **测试场景**：任务结果公示

   - 输入：任务执行完成
   - 预期结果：只显示总体结果（成功/失败），不显示个人选择

2. **测试场景**：任务选择加密验证
   - 输入：验证任务选择信息传输
   - 预期结果：信息经过加密，无法通过网络分析获取谁选择了失败

### 5.5 刺客阶段与游戏结束处理测试

#### 5.5.1 刺客功能测试（P0）

1. **测试场景**：刺客选择梅林

   - 输入：刺客选择梅林角色
   - 预期结果：刺杀成功，邪恶阵营获胜

2. **测试场景**：刺客选择非梅林角色

   - 输入：刺客选择非梅林角色
   - 预期结果：刺杀失败，正义阵营获胜

3. **测试场景**：刺客权限验证
   - 输入：非刺客角色尝试执行刺杀
   - 预期结果：操作被拒绝，返回错误信息

#### 5.5.2 游戏结果展示（P1）

1. **测试场景**：游戏结束角色公开

   - 输入：游戏结束
   - 预期结果：所有玩家角色信息被公开

2. **测试场景**：游戏统计数据展示
   - 输入：游戏结束
   - 预期结果：显示游戏统计数据，如任务成功/失败次数、投票情况等

#### 5.5.3 游戏历史记录（P2）

1. **测试场景**：游戏历史保存

   - 输入：游戏结束
   - 预期结果：游戏历史记录被正确保存到数据库

2. **测试场景**：游戏历史查询
   - 输入：查询特定游戏历史
   - 预期结果：返回正确的游戏历史记录

## 6. 性能测试

### 6.1 并发测试

1. **测试场景**：多房间并发游戏

   - 输入：多个房间同时进行游戏
   - 预期结果：系统正常运行，无明显延迟

2. **测试场景**：高频操作测试
   - 输入：短时间内执行大量游戏操作
   - 预期结果：系统能够处理所有操作，无数据丢失

### 6.2 负载测试

1. **测试场景**：服务器负载测试

   - 输入：模拟大量玩家同时在线
   - 预期结果：系统稳定运行，响应时间在可接受范围内

2. **测试场景**：数据库负载测试
   - 输入：大量游戏数据写入和读取
   - 预期结果：数据库操作正常，无明显延迟

## 7. 安全测试

### 7.1 防作弊测试

1. **测试场景**：客户端数据篡改测试

   - 输入：尝试修改客户端发送的游戏数据
   - 预期结果：服务器检测到异常，拒绝非法操作

2. **测试场景**：角色信息窃取测试
   - 输入：尝试获取其他玩家的角色信息
   - 预期结果：操作被拒绝，角色信息保持保密

### 7.2 授权测试

1. **测试场景**：非法操作测试

   - 输入：玩家尝试执行非当前状态允许的操作
   - 预期结果：操作被拒绝，返回适当的错误信息

2. **测试场景**：超时操作测试
   - 输入：超过操作时限后尝试执行操作
   - 预期结果：操作被拒绝，游戏状态已进入下一阶段

## 8. 测试执行计划

### 8.1 测试阶段

1. **单元测试阶段**：开发过程中持续进行
2. **集成测试阶段**：功能模块完成后进行
3. **系统测试阶段**：所有功能集成后进行
4. **性能测试阶段**：基本功能稳定后进行
5. **安全测试阶段**：发布前必须完成

### 8.2 测试时间表

| 阶段     | 开始日期       | 结束日期       | 负责人       |
| -------- | -------------- | -------------- | ------------ |
| 单元测试 | 项目启动+5 天  | 持续进行       | 各模块开发者 |
| 集成测试 | 项目启动+15 天 | 项目启动+20 天 | 测试团队     |
| 系统测试 | 项目启动+20 天 | 项目启动+25 天 | 测试团队     |
| 性能测试 | 项目启动+25 天 | 项目启动+28 天 | 性能测试专家 |
| 安全测试 | 项目启动+25 天 | 项目启动+30 天 | 安全测试专家 |

### 8.3 测试资源

- 测试团队：3-4 人
- 测试环境：开发服务器 1 台，测试服务器 2 台
- 测试工具：Jest, Supertest, Artillery（性能测试）

## 9. 风险与缓解措施

| 风险                       | 可能性 | 影响 | 缓解措施                             |
| -------------------------- | ------ | ---- | ------------------------------------ |
| 复杂游戏规则导致逻辑错误   | 高     | 高   | 详细的单元测试，游戏规则专家评审     |
| 并发问题导致游戏状态不一致 | 中     | 高   | 严格的并发测试，事务控制机制         |
| 网络延迟影响用户体验       | 中     | 中   | 实现状态同步和恢复机制，优化网络传输 |
| 安全漏洞导致作弊行为       | 低     | 高   | 全面的安全审计，服务端验证所有操作   |
| 数据库性能瓶颈             | 低     | 中   | 优化数据库查询，实现缓存机制         |

## 10. 测试报告模板

### 10.1 测试摘要报告

- 测试时间范围
- 测试执行统计（通过/失败/阻塞）
- 主要发现的问题
- 未解决的关键问题
- 测试结论与建议

### 10.2 缺陷报告模板

- 缺陷 ID
- 严重程度（阻塞/严重/一般/轻微）
- 复现步骤
- 预期结果与实际结果
- 环境信息
- 截图或日志
- 相关测试用例

## 11. 测试完成标准

1. 所有 P0 级测试用例必须通过
2. 所有 P1 级测试用例至少 95%通过，且无严重缺陷
3. P2 级测试用例至少 90%通过，且无影响核心功能的缺陷
4. 性能测试指标满足：响应时间<500ms，支持同时运行至少 50 个游戏房间
5. 安全测试无高危漏洞

## 12. 附录

### 12.1 测试环境配置详情

```json
{
  "开发环境": {
    "操作系统": "Ubuntu 20.04 LTS",
    "Node版本": "16.x",
    "数据库": "MongoDB 5.0, Redis 6.2",
    "网络": "内部测试网络"
  },
  "UAT环境": {
    "操作系统": "Ubuntu 20.04 LTS",
    "Node版本": "16.x",
    "数据库": "MongoDB 5.0, Redis 6.2",
    "网络": "模拟生产网络条件"
  }
}
```

### 12.2 参考文档

- [阿瓦隆游戏规则](../../../阿瓦隆游戏规则.md)
- [游戏核心逻辑技术方案](../技术方案.md)
- [Task5.2.1 至 Task5.2.5](./Task5.2.1-游戏状态和流程管理.md)
