# Story 5.2: 游戏核心逻辑

## 概述

游戏核心逻辑是阿瓦隆微信小游戏的核心部分，负责实现整个游戏流程的管理、状态转换、角色分配、任务执行等核心功能。本故事包含设计和实现游戏的核心规则和逻辑，确保游戏能够按照阿瓦隆的规则正确运行。

## 文档清单

### 1. 主要文档

- [技术方案.md](./技术方案.md) - 详细的技术方案，包括系统设计、数据模型、游戏状态转换、API 设计和安全考虑
- [测试计划.md](./测试计划.md) - 全面的测试计划，包括测试用例、测试策略和测试执行计划

### 2. 任务文档

- [Task5.2.1-游戏状态和流程管理.md](./Task5.2.1-游戏状态和流程管理.md) - 游戏状态机和生命周期管理
- [Task5.2.2-角色分配与管理.md](./Task5.2.2-角色分配与管理.md) - 角色分配、信息可见性和特殊能力实现
- [Task5.2.3-组队和投票系统.md](./Task5.2.3-组队和投票系统.md) - 队长轮换、组队和投票功能
- [Task5.2.4-任务执行系统.md](./Task5.2.4-任务执行系统.md) - 任务选择、结果计算和任务执行流程
- [Task5.2.5-刺客阶段与游戏结束处理.md](./Task5.2.5-刺客阶段与游戏结束处理.md) - 刺客刺杀和游戏结束处理

## 重要设计决策

1. **状态管理模式**：采用有限状态机(FSM)模式管理游戏状态，确保状态转换的清晰和可控。
2. **角色信息安全**：实现严格的角色信息可见性控制，确保只有特定角色能看到特定信息。
3. **服务端验证**：所有游戏逻辑和验证在服务端执行，防止客户端作弊。
4. **事件驱动架构**：采用事件驱动模式处理游戏状态转换和通知。
5. **数据一致性**：使用事务和版本控制确保分布式环境下的数据一致性。

## 技术栈

- **后端语言**: TypeScript
- **框架**: NestJS
- **数据存储**: MongoDB (持久化存储), Redis (缓存和实时数据)
- **通信**: WebSocket (实时通信), REST API (非实时操作)
- **状态管理**: 自定义 FSM (有限状态机)
- **测试**: Jest (单元和集成测试)

## 关键接口

### REST API

1. **游戏创建**: `POST /api/games`
2. **游戏启动**: `POST /api/games/:gameId/start`
3. **游戏状态查询**: `GET /api/games/:gameId`
4. **玩家游戏信息**: `GET /api/games/:gameId/players/:playerId`

### WebSocket 事件

1. **游戏状态更新**: `game.state.updated`
2. **角色分配**: `game.roles.assigned`
3. **队伍提案**: `game.team.proposed`
4. **投票更新**: `game.vote.updated`
5. **任务结果**: `game.mission.completed`

## 工作量总结

| 任务                   | 估计工作量 (人天) |
| ---------------------- | ----------------- |
| 游戏状态和流程管理     | 9                 |
| 角色分配与管理         | 8                 |
| 组队和投票系统         | 7                 |
| 任务执行系统           | 6                 |
| 刺客阶段与游戏结束处理 | 6                 |
| **总计**               | **36**            |

## 依赖关系

- 依赖 [Story5.1-房间管理系统](../Story5.1-房间管理系统/README.md) 提供的房间和玩家管理功能
- 被 [Story5.3-实时通信服务](../Story5.3-实时通信服务/README.md) 依赖，提供游戏状态和事件

## 相关资源

- [阿瓦隆游戏规则](../../阿瓦隆游戏规则.md)
- [游戏核心逻辑技术方案](./技术方案.md)

## 完成标准

1. 所有核心游戏规则正确实现
2. 通过所有 P0 级测试用例
3. 游戏流程完整且符合阿瓦隆规则
4. 提供完整的 API 文档
5. 代码质量符合团队标准
